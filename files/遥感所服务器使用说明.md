# 遥感所服务器使用说明

本文修改自 https://shimo.im/docs/TXKTy6WXcyDjH8Xc/

最后编辑时间2021-03-05
 

**注意，服务器（虽然总体比较稳定）可能出现硬盘损坏、断电、中毒等问题，会导致服务器关机、无法启动、数据丢失泄漏、系统崩溃等，请注意务必备份自己的重要数据代码，自己承担风险，管理员不负任何责任。**

- [遥感所服务器使用说明](#遥感所服务器使用说明)
  - [209 服务器账户概况](#209-服务器账户概况)
    - [Anaconda 与 ISIS 软件](#anaconda-与-isis-软件)
  - [总体情况](#总体情况)
    - [计算资源](#计算资源)
    - [硬盘](#硬盘)
    - [网络](#网络)
    - [端口](#端口)
    - [深度学习](#深度学习)
  - [安全](#安全)
- [附录--密钥生成与配置方法：](#附录--密钥生成与配置方法)
  - [Windows](#windows)
    - [xshell](#xshell)
    - [putty](#putty)
  - [MacOS/Linux](#macoslinux)
      - [附录--虚拟机管理员手册：](#附录--虚拟机管理员手册)

## 209 服务器账户概况

需要使用服务器的同学，请先联系**刘晓峰**或**贾博钧**建立自己的账户。
**服务器禁止使用密码登录，因此需要登录服务器的机器需要生成密钥，使用密钥登录。** 密钥生成方法见[附录](#附录--密钥生成与配置方法)。

服务器地址 `162.105.159.47`，我们实验室分配到的端口是 `20030`，用户名为自己的用户名，以 `isis209` 为例，可以使用如下命令登录服务器：

```bash
ssh -p 20030 isis209@162.105.159.47
```

第一次登录服务器时可能会提示修改密码，需要先输入默认初始密码：12345678，然后输入自己设置的密码。由于已经存在密钥，未来登录时不需要使用该密码。

### Anaconda 与 ISIS 软件
账户下已经安装好 anaconda 环境，登录进账户，可以直接使用conda命令，先使用 `conda env list` 命令查看当前环境和可用环境列表（默认环境应为base，可以先`deactivate`，再激活其他环境）。

如果需要使用 ISIS 软件，需要使用 `conda activate isis` 激活 **isis** 环境。

如果需要安装其它包，请[连接网络](#网络)并重新创建新的 conda 环境，**请勿直接在 base 和 isis 环境中安装其它包**！conda 默认安装新环境在 `/opt/anaconda3/envs/` 下，但为了避免可能的文件读写权限问题，推荐使用 `-p ~/.conda/envs/env_name` 选项在自己的主目录下安装。

普通账户没有 `sudo` 权限，因此需要安装其它软件或进行其它需要管理员权限的操作请联系 **刘晓峰**、**贾博钧**。系统已经有 gcc 等编译器，以及其它大多数软件，需要使用的时候请先用 `which` 等命令查找软件，确定需要安装时再联系管理员。


## 总体情况

这是运行于资源东楼机房的服务器，每个实验室会分配一个虚拟机，可以方便地进行组内的实验，一个虚拟机里可以开多个账户给组内成员使用。

### 计算资源 
深度学习服务器配有4块2080Ti显卡，2个`Intel Xeon Gold 5118 12C 2.30GHz` CPU，256GB内存。

### 硬盘
`/shared_ssd`目录挂载了1.6T左右的共享的固态硬盘，读写数据快，可以优先使用，其它的虚拟机都能够读写访问，使用时在目录下创建一个自己的文件夹在里面存数据，以免删了别人的文件或者自己的文件被别人删除。虚拟机系统盘分配了2TB左右的硬盘，但整个服务器只有10TB硬盘，整体硬盘容量有限，**不要用来长期存储数据，不用的大文件数据务必及时删除**，如果硬盘占满会导致虚拟机无法使用。

### 网络
只能从校内ip才能登录服务器，从校外ip无法主动连接。服务器需要连接网关才能下载外网数据，可以使用`/home/isis209/tools`文件夹下的`connect`工具用自己的校园网账号连接学校网关，连接上后机器上的所有虚拟机都能够上外网，断开后所有虚拟机都会断开外网的访问。服务器的ip是学校动态分配的，但一般少改变，如改变之后连不上服务器请联系管理员。

### 端口
通过端口映射使得能够通过ssh访问虚拟机，虚拟机的8880-8889端口被映射到主机连续的10个端口上，其中8880是虚拟机的ssh端口，被映射到主机的起始端口上，用户开启jupyter等服务之后可以通过映射后的端口访问（例如，ssh登陆时的端口是20000，那么虚拟机的8880-8889端口映射为主机的20000-20009端口了，在虚拟机开jupyter为8888端口，通过主机的20008端口就能访问了）。

### 深度学习

- 虚拟机与主机共享4块2080TI显卡与驱动，g02驱动版本为430.26；g01驱动版本为440.26，驱动版本在虚拟机内无法修改。
- 需要自行安装自己需要版本的CUDA， **安装CUDA时会询问是否需要显卡安装驱动时选择“no”**， `/home/isis209/tools`里存了CUDA 10的安装包。


## 安全

需要注意规范使用服务器，否则可能导致代码数据被盗，服务器中毒等情况（如计算中心的通知：https://its.pku.edu.cn/announce/tz20190830153200.jsp）。为了保证服务器安全，需要注意以下事项：

- 服务器已禁止使用密码登陆，只有使用密钥才能登陆服务器，开设账号时需要自己生成密钥（密钥生成方法见附录），把公钥复制给服务器/虚拟机管理员，自己保密好私钥匙作为登陆的凭证，私钥泄漏可能导致虚拟机中毒、代码数据泄漏、ip被封锁等后果。
- 服务器已设置防火墙，只有本部**校内ip才能访问**（公网ip暴露很危险，计算中心也会封禁校外来的ssh），如果需要在校外访问，需要连北京大学vpn，再连接服务器。
- 避免下载来源不明的程序，运行不了解的代码，不要随意开端口（数据库、Web服务器等），**开Jupyter等服务一定要设置密钥。**
- 可以重启虚拟机，但**不要关机**，除非后面不需要使用了。关机之后会连不上虚拟机，无法自行开机，只能通过服务器管理员开机。


-----

# 附录--密钥生成与配置方法：

密钥包括相互对应的公钥与私钥，需要在登录的机器上生成，然后把公钥交给管理员后，管理员会把它复制到服务器自己账号下`~/.ssh/authorized_keys`文件里，这样在登录的时候使用自己的私钥就可以直接登录服务器。私钥是登录服务器的唯一凭证，不能交给他人或复制到其他地方，防止泄漏。

如果之后自己有另一台机器也想登录服务器，可以自己在另一台机器上生成密钥，然后自己将公钥追加到自己账号`~/.ssh/authorized_keys`文件里。

密钥生成方法如下（网上也有很多介绍生成密钥的方法）：

## Windows
Windows下常用的两个连接SSH软件是xshell和putty，两者需要密钥的格式有差别，但内容和原理都是一致的。生成密钥方法如下：

### xshell
在菜单栏“工具--新建用户密钥生成向导”，然后一直点下一步就可以生成密钥，可以不设置给密钥加密的密码。生成后，在用户密钥里选中生成的密钥，点击”属性--公钥“，公钥格式就按默认的”SSH2 - OpenSSH“，就可以复制出公钥了。登录时，在“新建会话属性窗口”配置好ip和端口后，点击左侧的“用户身份验证”，可以选择身份认证方法，方法选择“Public Key”，然后“用户密钥”选择之前生成的密钥。配置好ip，端口，用户名和密钥后就可以登录了。

### putty
putty会自带PuTTYgen软件用于生成密钥，打开PuTTYgen，按照默认的参数，点击“Generate”，等待计算生成完毕，最上方会出现“Public key for pasting into OpenSSH authorized_keys file：”，下面方框里显示的一大长串就是公钥，把它复制后保存在文件里发给管理员，放在服务器上。点击“Save Private Key”将私钥保存到安全的地方，作为登录的凭证。登录时，配置好ip和端口，点击左侧“Connection--SSH--Auth”，可以在"Private key file for authentication"下选择自己的私钥。配置好ip，端口，用户名和密钥后就可以登录了。

## MacOS/Linux
如果已经生成过密钥，默认存储在`~/.ssh`目录下。如果没有生成过，在命令行运行`ssh-keygen`命令，然后一路回车，就会生成公钥`~/.ssh/id_rsa.pub`与私钥`~/.ssh/id_rsa`。登录时使用命令行运行`ssh -p <port> <user_name>@<ip>`就可以直接登录了。


#### 附录--虚拟机管理员手册：

虚拟机管理员账户为irsgis，有sudo权限。服务器管理员创建完虚拟机后，会把密码给虚拟机管理员，可以在虚拟机给自己/同学开账号使用，开账户之前请把此说明发给使用者，仔细阅读后再开户。

如要开的帐户名为zhangsan：

```
$ sudo ls
$ sudo adduser zhangsan
```

然后按照流程输入临时的密码（固定为12345678）。

将用户添加进anaconda用户组

```
sudo usermod -a -G anaconda zhangsan
```

完成后设置第一次登录时需要修改密码：

```
$ sudo passwd -e zhangsan
```

由于登录需要使用密钥，需要让用户生成密钥，然后写入该帐户的`~/.ssh/authorized_keys`文件里（`~`代表该
用户的home目录，如对于zhangsan，完整的路径为`/home/zhangshan/.ssh/authorized_keys`）：

```
# 切换为新开的用户

$ sudo su zhangsan
# 到home目录下
$ cd ~
$ mkdir .ssh
# 写入用户的公钥
$ vim .ssh/authorized_keys

# 将tools/connect、readme拷贝到用户目录，并执行/opt/anaconda3/bin/conda init。
$ mkdir tools
$ cp ~/../irsgis/tools/connect ~/tools/
$ /opt/anaconda3/bin/conda init

# 写入后，切换为管理员用户
$ exit
```

这样用户就可以使用自己的密钥登录了。新开的用户没有管理权限，如果用户需要管理员权限，需要添加sudo权限：

```
$ sudo usermod -aG sudo zhangsan
```

如果某个账号不需要使用了，记得及时删除并清理该用户的文件：

```
$ deluser --remove-home --remove-all-files zhangsan
```